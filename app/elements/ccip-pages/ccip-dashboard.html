<!--
@license

-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="ccip-dashboard">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-meta id="meta"></iron-meta>

    <h1 class="page-title" tabindex="-1">Dashboard</h1>
    <div class="row">
      <div class="dashboard-box">
        <h3>Day1</h3>
        <div x-title="報到狀態\n共 %total% 名會眾" x-used-text="已報到" x-unused-text="未報到" id="day1checkin_used" class="col-sm-4 chart-box"></div>
        <div x-title="迎賓袋\n" x-used-text="已領取" x-unused-text="未領取" id="kit_used" class="col-sm-4 chart-box"></div>
        <div x-title="午餐(葷)\n" x-used-text="已領取" x-unused-text="未領取" id="day1lunch-meat" class="col-sm-4 chart-box"></div>
        <div x-title="午餐(素)\n" x-used-text="已領取" x-unused-text="未領取" id="day1lunch-vegetarian" class="col-sm-4 chart-box"></div>
      </div>
    </div>
    <hr>
    <div class="row">
      <div class="dashboard-box">
        <h3>Day2</h3>
        <div x-title="報到狀態\n共 %total% 名會眾" x-used-text="已報到" x-unused-text="未報到" id="day2checkin_used" class="col-sm-4 chart-box"></div>
        <div x-title="午餐(葷)\n" x-used-text="已領取" x-unused-text="未領取" id="day2lunch-meat" class="col-sm-4 chart-box"></div>
        <div x-title="午餐(素)\n" x-used-text="已領取" x-unused-text="未領取" id="day2lunch-vegetarian" class="col-sm-4 chart-box"></div>
      </div>
    </div>
    <hr>
    <div class="dashboard-box">
      <p>Auto update every 30 sec.</p>
      <p><button type="button" on-click="reload">Update!</button></p>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'ccip-dashboard',

        properties: {
          status: {
            type: Object,
            observer: 'statusChanged'
          },
          charts: Object
        },

        statusChanged: function(newStatus, oldStatus) {
          // console.log(newStatus, oldStatus);
          Array.from(this.querySelectorAll('.chart-box')).map(n => {
            var k = n.id;
            var title = n.getAttribute('x-title').replace(/\\n/g, '<br />').replace(/%total%/g, newStatus.total);
            var usedText = n.getAttribute('x-used-text');
            var unusedText = n.getAttribute('x-unused-text');
            var data = [];
            var key = k.match(/-/) != null ? k.split('-').shift() : k;
            if (k.match(/lunch/i) != null && !!newStatus[key]) {
              var subkey = k.match(/lunch-(.*)$/).pop();
              data = [
                {
                  name: `${dietMapping.meat} ${usedText}`,
                  y: newStatus[key][`${subkey}_used`],
                  sliced: true,
                  selected: true
                },
                {
                  name: `${dietMapping.meat} ${unusedText}`,
                  y: newStatus[key][subkey] - newStatus[key][`${subkey}_used`],
                  sliced: true,
                  selected: true
                }
              ];
            } else {
              data = [
                {
                  name: usedText,
                  y: newStatus[k],
                  sliced: true,
                  selected: true
                },
                [unusedText, ((newStatus.total || 0) - newStatus[k])]
              ];
            }
            if (!!this.charts[k]) {
              this.charts[k].series[0].setData(data, true);
              this.charts[k].setTitle({ text: title });
            } else {
              this.charts[k] = new Highcharts.Chart({
                colors: ['#3D983C', '#CCCCCC'],
                chart: {
                  renderTo: k,
                  plotBackgroundColor: null,
                  plotBorderWidth: null,
                  plotShadow: false
                },
                title: {
                  text: title
                },
                tooltip: {
                  pointFormat: '{series.name}: <b>{point.percentage: .1f}%</b>'
                },
                plotOptions: {
                  pie: {
                    allowPointSelect: false,
                    cursor: 'pointer',
                    dataLabels: {
                      enabled: true,
                      formatter: function() {
                        return `${this.y} ( ${Math.round(this.percentage * 100) / 100}% )`;
                      },
                      distance: -50
                    },
                    showInLegend: true
                  }
                },
                series: [{
                  type: 'pie',
                  name: 'Percentage',
                  data: data
                }]
              });
            }
          });
        },

        reload: function() {
          var charts = this.charts;
          new Promise((resolve, reject) => {
            this.status = {
              total: '--'
            };
            setTimeout(() => resolve(), 0);
          }).then(() => {
            $.ajax({
              url: this.$.meta.byKey('api.dashboard'),
              type: 'get',
              dataType: 'json',
              success: json => {
                console.log(`Response: ${JSON.stringify(json, null, 2)}`);
                this.status = json;
                setTimeout(function() {
                  for(var k in charts) {
                    charts[k].reflow();
                  }
                }, 250);
              },
              error: e => {
                console.log('Error: ', e);
              }
            });
          });
        },

        attached: function() {
          this.reload();
          var self = this;
          setInterval(function() {
            self.reload();
          }, 30 * 1000);
        },

        ready: function() {
          this.charts = {};
        }
      });
    })();
  </script>
</dom-module>
