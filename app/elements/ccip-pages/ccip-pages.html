<!--
@license

-->
<dom-module id="ccip-pages">
  <template>
    <iron-meta key="oneSignalUrl.debugToken" value="aef99f72-9ee3-4dfa-ac5b-ddf79f16be7d"></iron-meta>
    <iron-meta key="oneSignalUrl.debugAuthToken" value="87e31319-701d-4ee5-a57e-7da788af768d"></iron-meta>
    <iron-meta key="oneSignalUrl.releaseToken" value="a429ff30-5c0e-4584-a32f-b866ba88c947"></iron-meta>
    <iron-meta key="oneSignalUrl.releaseAuthToken" value="a93c32e9-e769-4716-bb56-90c3ccc445f0"></iron-meta>
    <iron-meta key="oneSignalUrl.players" value="https://onesignal.com/api/v1/players"></iron-meta>
    <iron-meta key="oneSignalUrl.notifications" value="https://onesignal.com/api/v1/notifications"></iron-meta>
    <iron-meta key="api.status" value="https://coscup.cprteam.org/status"></iron-meta>
    <iron-meta key="api.use" value="https://coscup.cprteam.org/use/"></iron-meta>
    <iron-meta key="api.dashboard" value="https://coscup.cprteam.org/dashboard"></iron-meta>
    <iron-meta key="api.sponsors" value="https://coscup.cprteam.org/sponsor/checkin"></iron-meta>
    <iron-meta key="api.announcement" value="https://coscup.cprteam.org/announcement"></iron-meta>
    <iron-meta key="api.res1" value="/day1_res"></iron-meta>
    <iron-meta key="api.res2" value="/day2_res"></iron-meta>
    <iron-meta key="api.auth.username" value="ccip"></iron-meta>
    <iron-meta key="api.auth.password" value="alwaysconnectme"></iron-meta>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'ccip-pages',

        properties: {
          isMobile: Object,
          modelList: Object,
          scenarioMapping: Object,
          dietMapping: Object
        },

        ready: function() {
          $(this).on('reload-clicked', () => {
            new Promise((resolve, reject) => {
              app.$.refresh.hidden = true
              setTimeout(() => resolve(app.$.spinner.active = true), 250);
            }).then(() => {
              app.$.refresh.ccip.map(c => {
                if (!!c.reload && typeof(c.reload) === 'function') {
                  c.listen(c, 'reloaded', '__reloaded');
                  console.log('Trigger %c%s%c reload event: reload() => %c%s', 'color: purple', c.is, '', 'color: orange', c.reload());
                }
              });
            });
          });
          window.addEventListener('WebComponentsReady', function() {
            // imports are loaded and elements have been registered
            ((self) => {
              var route = self.selected;
              var page = self.selectedItem;
              Array.from($(self).find('*')).filter(n => n.tagName.match(/^ccip-/i)).map(c => {
                c.isActive = false;
                c.active = () => {
                  c.isActive = true;
                };
                c.deactive = () => {
                  c.isActive = false;
                };
              });
              var ccipSelected = Array.from(self.selectedItem.querySelectorAll('*'))
                .map(n => n.tagName.toLowerCase().match(/^ccip-/i) != null && n || null)
                .filter(n => n);
              ccipSelected.map(c => !!c.active && c.active());
            })(document.querySelector('#pages-content'));
            var previousRoute = '';
            $('#pages-content').on('iron-resize', function() {
              var route = this.selected;
              var page = this.selectedItem;
              if (route != previousRoute) {
                previousRoute = route;
                var ccips = Array.from($(this).find('*')).filter(n => n.tagName.match(/^ccip-/i));
                var ccipSelected = Array.from(this.selectedItem.querySelectorAll('*'))
                  .map(n => n.tagName.toLowerCase().match(/^ccip-/i) != null && n || null)
                  .filter(n => n);
                ccips.filter(c => c.isActive).map(c => !!c.deactive && c.deactive());
                ccipSelected.map(c => !!c.active && c.active());
                app.$.refresh.ccip = ccipSelected;
                ccipSelected.map(c => {
                  var haveReload = !!c.reload;
                  app.$.refresh.hidden = !haveReload;
                  app.$.spinner.active = false;
                  if (haveReload) {
                    c.__reloaded = () => {
                      new Promise((resolve, reject) => {
                        app.$.spinner.active = false;
                        c.unlisten(c, 'reloaded', '__reloaded');
                        setTimeout(() => resolve(), 250);
                      }).then(() => app.$.refresh.hidden = false);
                    };
                  } else {
                    if (!!c.__reloaded) {
                      delete c.__reloaded;
                    }
                  }
                });
              }
            });
          });
          const parameters = location.hash.split('?').pop().split('&').map(p => {
            var ps = p.split('=');
            var o = {};
            o[ps.shift()] = ps.join('=');
            return o;
          }).reduce((a, b) => {
            var o = a;
            for(var k in b) {
              o[k] = b[k];
            }
            return o;
          });
          const isMobile = {
            get iOS() {
              return navigator.userAgent.match(/iPhone|iPad|iPod/i) ? true : false;
            },
            get Android() {
              return navigator.userAgent.match(/Android/i) ? true : false;
            },
          };
          const modelList = ['iOS', 'Android', 'Amazon', 'WindowsPhone(MPNS)', 'ChromeApp', 'ChromeWebsite', 'WindowsPhone(WNS)', 'Safari', 'Firefox', 'Mac OS X'];
          const scenarioMapping = {
            day1checkin: { icon: 'day1checkin', title: 'Day1 報到', text: 'Checkin!' },
            kit: { icon: 'kit', title: '迎賓袋', text: 'Action!' },
            vipkit: { icon: 'vipkit', title: '獨家紀念品', text: 'Action!', meta: '僅限個人贊助方案' },
            day1lunch: { icon: 'lunch', title: 'Day1 午餐', text: 'Action!' },
            day2checkin: { icon: 'day2checkin', title: 'Day2 報到', text: 'Checkin!' },
            day2lunch: { icon: 'lunch', title: 'Day2 午餐', text: 'Action!' }
          };
          const dietMapping = {
            meat: '葷食',
            vegetarian: '素食'
          };

          this.parameters = parameters;
          this.isMobile = isMobile;
          this.modelList = modelList;
          this.scenarioMapping = scenarioMapping;
          this.dietMapping = dietMapping;

          Highcharts.setOptions({
            credits: {
              enabled: false
            }
          });

          window.ccipPages = this;
        }
      });
    })();
  </script>
</dom-module>

<ccip-pages id="ccip-pages" />

<link rel="import" href="ccip-dashboard.html">
<link rel="import" href="ccip-sponsors.html">
<link rel="import" href="ccip-check-in.html">
<link rel="import" href="ccip-devices-info.html">
<link rel="import" href="ccip-announcement.html">
<link rel="import" href="ccip-push-notification.html">
<link rel="import" href="ccip-contributors.html">
<link rel="import" href="ccip-punch-area.html">
